<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Momentree</title>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

        <style>
            body {
                margin: 0;
                background-color: #fffcf5;
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                overflow: hidden;
            }

            .loader {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);

                width: 30px;
                height: 30px;

                border: 3px solid #ddd;
                border-top-color: #333;
                border-radius: 50%;

                animation: spin 1s infinite linear;

                z-index: 1;
            }

            @keyframes spin {
                0% {transform: translate(-50%, -50%) rotate(0deg); }
                100% {transform: translate(-50%, -50%) rotate(360deg); }
            }

            .swiper {
                width: auto;
                height: 60vh;
                aspect-ratio: 783/2346;

                max-width: 85vw;
                max-height: 80vh;

                overflow: visible;
            }

            .swiper-slide {
                width: 100%;
                height: 100%;

                display: flex;
                justify-content: center;
                align-items: center;
            }

            .swiper-slide-active .card .card-face {
                filter: blur(0) brightness(1);
            }

            .card {
                width: 100%;
                height: 100%;
                
                position: relative;
                transform-style: preserve-3d;

                transition: transform 0.6s;

                cursor: pointer;

            }

            .card.is-flipped {
                transform: rotateY(180deg);
            }

            .card-face {
                position: absolute;

                width: 100%;
                height: 100%;

                border-radius: 2px;

                background-size: cover;
                background-position: center;
                background-color: #fffcf5;

                backface-visibility: hidden;
                overflow: hidden;

                transition: filter 0.6s;
                filter: blur(5px) brightness(0.96);
            }

            .card-face img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;

                opacity: 0;
                transition: opacity 0.5s ease-in;

                position: relative;
                z-index: 2;
            }

            .card-face img.loaded {
                opacity: 1;
            }

            .card-back {
                transform: rotateY(180deg);
            }

            #title {
                margin: 0;
                margin-bottom: 60px;

                font-family: 'Avenir', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
                font-size: 24px;
                font-weight: normal;
                letter-spacing: 4px;

                color: #141e1f ;

                z-index: 100;
            }

            #counter {
                margin-top: 30px;
                z-index: 100;

                font-family: 'Avenir', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
                font-size: 14px;
                color: #888;
                letter-spacing: 2px;
            }

            #random-btn {
                margin-top: 45px;
                z-index: 100;

                width: 36px;
                height: 36px;
                
                flex-shrink: 0;
                padding: 0;

                border-radius: 50%;
                border: none;
                background-color: #fffcf5;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                
                display: flex;
                justify-content: center;
                align-items: center;
                
                cursor: pointer;
                transition: transform 0.1s;

            }

            #random-btn img {
                width: 100%;
                height: 100%;

                object-fit: contain;
                
                margin: 0;
                display: block;
            }

            #random-btn:active {
                transform: scale(0.95);
            }
        </style>
    </head>

    <body>
        <h1 id="title">Momentree</h1>

        <div class="swiper">
            <div class="swiper-wrapper" id="card-container"></div>
        </div>

        <div id="counter"></div>

        <button id="random-btn" aria-label="Shuffle">
            <img src="img/shuffle.svg" alt="shuffle icon">
        </button>

        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

        <script>
            const totalCards = 198;

            const slidesData = [];

            for (let i = 1; i <= totalCards; i++) {
                let frontNum = (i * 2) - 1;
                let backNum = (i *2);

                let frontNumStr = String(frontNum).padStart(3, '0');
                let backNumStr = String(backNum).padStart(3, '0');

                slidesData.push({
                    frontSrc: `img/card-${frontNumStr}.jpg`,
                    backSrc: `img/card-${backNumStr}.jpg`,
                    id: i
                });
            }

            const randomStartIndex = Math.floor(Math.random() * totalCards);

            const swiper = new Swiper('.swiper', {
                effect: 'cards',
                grabCursor: true,
                centeredSlides: true,
                slidesPerView: 'auto',
                loop: true,
                initialSlide: randomStartIndex,
                keyboard: false,

                preloadImages: false,
                updateOnImagesReady: false,

                virtual: {
                    slides: slidesData,
                    addSlidesBefore: 2,
                    addSlidesAfter: 2,

                    renderSlide: function (slideContent, index) {
                        return `
                            <div class="swiper-slide">
                                <div class="card">
                                    <div class="card-face card-front">
                                        <div class="loader"></div>
                                        <img src="${slideContent.frontSrc}" alt="front" onload="this.classList.add('loaded')">
                                    </div>

                                    <div class="card-face card-back">
                                        <div class="loader"></div>
                                        <img src="${slideContent.backSrc}" alt="front" onload="this.classList.add('loaded')">
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                },

                cardsEffect: {
                    slideShadows: false,
                    perSlideOffset: 40,
                    perSlideRotate: 2,
                },


                on: {
                    slideChange: function () {
                        const flippedCards = document.querySelectorAll('.card.is-flipped');
                        flippedCards.forEach(card => card.classList.remove('is-flipped'));

                        const counter = document.getElementById('counter');
                        const current = this.realIndex + 1;
                        counter.innerText = `${current} / ${totalCards}`
                    }
                }
            });

            document.addEventListener('keydown', (e) => {

                if (e.key === 'ArrowRight') {
                    e.preventDefault();

                    const activeSlide = swiper.el.querySelector('.card');
                    if (activeSlide) {
                        const card = activeSlide.querySelector('.card');
                        if (card) {
                            if (card.classList.contains('is-flipped')) {
                                swiper.slideNext();
                            } else {
                                card.classList.add('is-flipped');
                            }
                        }
                    }
                }

                if (e.key === 'ArrowLeft') {
                    swiper.slidePrev();
                }
            });

            document.addEventListener('click', (e) => {
                if (swiper.touchEventsData.isMoved) return;

                const activeSlide = swiper.el.querySelector('.swiper-slide-active');
                
                if (activeSlide) {
                        const activeCard = activeSlide.querySelector('.card');
                    if (activeCard) {
                        activeCard.classList.toggle('is-flipped');
                    }
                }
            });

            const counterElement = document.getElementById('counter');
            counterElement.innerText = `${swiper.realIndex + 1} / ${totalCards}`;

            const randomBtn = document.getElementById('random-btn');
            let isShuffling = false;

            randomBtn.addEventListener('click', (e) => {
                e.stopPropagation();

                if (isShuffling) return;
                isShuffling = true;

                const targetIndex = Math.floor(Math.random() * totalCards);
                const runUpCount = 20;

                let startIndex = targetIndex - runUpCount;
                if (startIndex < 0) startIndex = totalCards + startIndex;

                swiper.slideToLoop(startIndex, 0);

                let currentStep = 0;

                const moveNext = () => {
                    if (currentStep >= runUpCount) {
                        isShuffling = false;
                        return;
                    }

                    const progress = currentStep / runUpCount;

                    const minSpeed = 10;
                    const maxSpeed = 80;

                    const delay = minSpeed + (maxSpeed - minSpeed) * Math.pow(progress, 2);

                    swiper.slideNext(delay);

                    currentStep++;

                    setTimeout(moveNext, delay);
                };

                moveNext();
            });

        </script>
    </body>
</html> 